<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8" />
    <title>STLX GUI Wallet</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.js" integrity="sha512-dqw6X88iGgZlTsONxZK9ePmJEFrmHwpuMrsUChjAw1mRUhUITE5QU9pkcSox+ynfLhL15Sv2al5A0LVyDCmtUw==" crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.css" integrity="sha512-8bHTC73gkZ7rZ7vpqUQThUDhqcNFyYi2xgDgPDHc+GXVGHXq+xPjynxIopALmOPqzo9JZj0k6OqqewdGO3EsrQ==" crossorigin="anonymous" />
<style>
body {

  margin: 0;
  padding: 0;
  color: #fff;
  background:
    -webkit-linear-gradient(315deg, hsla(287.91, 26.72%, 22.73%, 1) 0%, hsla(287.91, 26.72%, 22.73%, 0) 70%),
    -webkit-linear-gradient(65deg, hsla(155.47, 31.16%, 32.41%, 1) 10%, hsla(155.47, 31.16%, 32.41%, 0) 80%),
    -webkit-linear-gradient(135deg, hsla(270.2, 40.58%, 24.5%, 1) 15%, hsla(270.2, 40.58%, 24.5%, 0) 80%),
    -webkit-linear-gradient(205deg, hsla(337.95, 42.36%, 22.49%, 1) 100%, hsla(337.95, 42.36%, 22.49%, 0) 70%);
  background:
    linear-gradient(135deg, hsla(287.91, 26.72%, 22.73%, 1) 0%, hsla(287.91, 26.72%, 22.73%, 0) 70%),
    linear-gradient(25deg, hsla(155.47, 31.16%, 32.41%, 1) 10%, hsla(155.47, 31.16%, 32.41%, 0) 80%),
    linear-gradient(315deg, hsla(270.2, 40.58%, 24.5%, 1) 15%, hsla(270.2, 40.58%, 24.5%, 0) 80%),
    linear-gradient(245deg, hsla(337.95, 42.36%, 22.49%, 1) 100%, hsla(337.95, 42.36%, 22.49%, 0) 70%);
  padding: 20px;
  overflow-x: hidden;

}
h2 { color: #fff; }
*, *::after, *::before {
	-webkit-user-select: none;
	-webkit-user-drag: none;
	-webkit-app-region: no-drag;
}
a { color: #d0d0d0; }
</style>
</head>
  <script>
	const decimal = 100000000;
	const {ipcRenderer} = require('electron');
	// send password to main.js
	var address = ipcRenderer.sendSync('request', "address" );
	var pubkey = ipcRenderer.sendSync('request', "pubkey" );
	//var txargs = ipcRenderer.sendSync('request', "txargs" );
  var queryDict = {};
	location.search.substr(1).split("&").forEach(function(item) {queryDict[item.split("=")[0]] = item.split("=")[1]});
  var txargs = queryDict["txargs"]; //"signtx/STLX57owh7oyGk5JFTeNGG4Fy19XRR8pQg7hTZS4HqRucFT5ZLRZKpFfi7CAWFSED9yE4XouyNHV5DUsYeij5vLD2Ro9/CTLU/232/";

	var isatomic = 0;
	var atomicp = 0;
	var atoms = [];
	var tokendecimals = {};

	async function postData(url = '', data = {}) {
	  // Default options are marked with *
	  const response = await fetch(url, {
		method: 'POST', // *GET, POST, PUT, DELETE, etc.
		mode: 'cors', // no-cors, *cors, same-origin
		cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
		credentials: 'same-origin', // include, *same-origin, omit
		headers: {
		  'Content-Type': 'application/json'
		  //'Content-Type': 'application/x-www-form-urlencoded',
		},
		redirect: 'follow', // manual, *follow, error
		referrerPolicy: 'no-referrer', // no-referrer, *no-referrer-when-downgrade, origin, origin-when-cross-origin, same-origin, strict-origin, strict-origin-when-cross-origin, unsafe-url
		body: data // body data type must match "Content-Type" header
	  });
	  return response.json(); // parses JSON response into native JavaScript objects
	}

	function gettokens()
	{
		fetch('https://node1.stlx.online/api/?q=gettokensbalance&address=' + address)
			.then(response => response.text())
			.then((response) => {
				var obj = JSON.parse(response);
				for (const [key, value] of Object.entries(obj.tokensbalance))
				{
					tokendecimals[key] = value[2];
				}
			});
	}
	/*
	function showatomic()
	{
		if(isatomic == 0 && atomicp > 0)
		{
			isatomic = 1;
			document.getElementById("tokens").style.display = "";
			document.getElementById("atomicbutton").innerHTML = '<i class="box icon"></i> UNSET ATOMIC TX';
		}
		else
		{
			isatomic = 0;
			document.getElementById("tokens").style.display = "none";
			document.getElementById("atomicbutton").innerHTML = '<i class="box icon"></i> SET ATOMIC TX';
		}
		if(atomicp == 0)
		{
			alert("You doesn't have transferible tokens for start an atomic transaction");
		}
	}
	*/
	function send()
	{
		var token = document.getElementById('token').innerHTML;
    if( token == "STLX") token = "";
		var amount = parseFloat(document.getElementById('amount').value);
		amount = document.getElementById('amount').innerHTML*tokendecimals[token];
		var dest = document.getElementById('contract').innerHTML;
		var fee = 300;
		var message = document.getElementById('message').innerHTML;
		var version = "4";
		var date = Math.round(parseInt(Date.now())/1000)-1;
		var txinfo = amount + "-" + date + "-"  + dest + "-" + fee + "-" + message + "-" + pubkey + "-" + token + "-" + version;
		ipcRenderer.send('setToSign', txinfo);
		var signature = ipcRenderer.sendSync('request', "sign");
		document.getElementById('sendbutton').classList.add("disabled");
		var txvalues = JSON.stringify({'amount' : amount, 'fee' : fee, 'dest' : dest, 'pubkey' : pubkey, 'date' : date, 'version' : version, 'message' : message, 'signature' : signature, 'token' : token });
		postData('https://node1.stlx.online/api/?q=transfer', txvalues)
		.then(data => {
			if(data.status == "ERROR")
			{
				alert("ERROR: " + data.response);
				quit();
			}
			else
			{
				alert("SENT! Hash: " + data.response);
				quit();
			}
		});
	}

  function quit()
	{
		window.close();
		return;
	}

	setInterval(function() {
		if(document.getElementById('address').innerHTML != "A")
		{
			document.getElementById('address').innerHTML = "A";
			gettokens();
		}
		if(document.getElementById('contract').innerHTML == "")
		{
			var txinfo = txargs.split("/");
      if(txinfo[0] == "signtx")
      {
        document.getElementById('contract').innerHTML = txinfo[1];
        document.getElementById('token').innerHTML = txinfo[2];
        document.getElementById('amount').innerHTML = txinfo[3];
        document.getElementById('message').innerHTML = txinfo[4];
        document.getElementById('fee').innerHTML = "0.000003 STLX";
      }
      else if(txinfo[0] == "asigntx")
      {
           atoms[txinfo[2]] = txinfo[3];
           atoms[txinfo[4]] = txinfo[5];
			     document.getElementById('contract').innerHTML = txinfo[1];
			     document.getElementById('token').innerHTML = txinfo[3] + " " + txinfo[2] + "<br>" + txinfo[5] + " " + txinfo[4];
			     //document.getElementById('amount').innerHTML = txinfo[3];
			     document.getElementById('message').innerHTML = "";
           document.getElementById('fee').innerHTML = "0.000005";
      }
		}
	}, 250);
  </script>

  </head>

    <body style="text-align:center;">
    <div style="position:absolute;top:50%;left:50%;margin-right:-50%;transform: translate(-50%, -50%);" class="ui container">
		<div class="text" style="margin-bottom:16px;font-size:32px;padding:8px;"><img class="ui centered tiny circular image" src="./assets/logo.png" /></div>
		<table id="s" class="ui inverted table" style="width:320px;">
		<thead style="word-break: break-all;">
		<th style="word-break: break-all;">Send to:<br>
		<span id="contract" style="word-break: break-all;"></span><span style="word-break: break-all;display: none;" id="address"></span></th>
		</thead>
		<tbody>
		<tr style="word-break: break-all;"><td style="word-break: break-all;">Tokens amount:<br><span style="word-break: break-all;" id="amount"></span> <span style="word-break: break-all;" id="token"></span></td></tr>
    <tr style="word-break: break-all;"><td style="word-break: break-all;">Fee<br><span style="word-break: break-all;" id="fee"></span> STLX</td></tr>
		<tr style="word-break: break-all;"><td style="word-break: break-all;">Message:<br><span style="word-break: break-all;" id="message"></span></td></tr>
		<tr style="word-break: break-all;"><td style="text-align:center;"><a href="#" id="sendbutton" onclick="send();" class="ui button green"><i class="paper plane icon"></i> SEND</a></td></tr>
		</tbody>
		</table>

		<!--<table id="d" class="ui inverted table" style="display:none;width:320px;">
		<thead style="word-break: break-all;">
		<th style="word-break: break-all;">SENT!></th>
		</thead>
		<tbody>
		<tr style="word-break: break-all;"><td style="word-break: break-all;"><span style="word-break: break-all;" id="senthash"></span></td></tr>
		<tr style="word-break: break-all;"><td style="text-align:center;"><a href="#" id="sendbutton" onclick="send();" class="ui button green"><i class="paper plane icon"></i> SEND</a></td></tr>
		</tbody>
		</table>-->
	</div>
	</body>
</html>
